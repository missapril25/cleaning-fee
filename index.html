<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掃地費登記小幫手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Noto+Sans+TC:wght@300;400;700&display=swap');
        :root { --accent: #10b981; --bg-base: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif; background-color: var(--bg-base); color: #1e293b; min-height: 100vh; }
        .bg-mesh { position: fixed; inset: 0; z-index: -10; background-image: radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.05) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.05) 0px, transparent 50%); }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.02); }
        .btn-gradient { background: linear-gradient(135deg, #10b981 0%, #0d9488 100%); transition: all 0.3s ease; }
        .month-item.selected { border-color: #10b981; background-color: #10b981; color: white; }
        #previewModal { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(15, 23, 42, 0.3); backdrop-filter: blur(12px); }
        .preview-table th { background-color: #f8fafc; font-size: 10px; padding: 12px 4px; border: 1px solid #f1f5f9; color: #64748b; }
        .preview-table td { font-size: 12px; padding: 10px 4px; text-align: center; border: 1px solid #f1f5f9; }
        .status-v { color: #10b981; font-weight: 700; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-10">

<div class="bg-mesh"></div>

<div id="app" class="max-w-7xl mx-auto relative z-10">
    <header class="flex flex-col items-center mb-12 text-center">
        <div class="inline-block px-4 py-1.5 mb-2 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-600 text-[10px] font-black tracking-widest uppercase">Database Connected</div>
        <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 tracking-tight">掃地費<span class="text-transparent bg-clip-text bg-gradient-to-br from-emerald-400 to-teal-600">登記小幫手</span></h1>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- 左側：交互表單 -->
        <div class="lg:col-span-4 space-y-6">
            <div class="glass-card p-6 md:p-8 rounded-[3rem]">
                <h2 class="text-lg font-extrabold mb-8 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-gradient-to-b from-emerald-400 to-teal-500 rounded-full"></span>
                    費用登記
                </h2>
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">繳款人姓名</label>
                        <select id="memberSelect" onchange="selectedMember = this.value" class="w-full bg-white/50 border border-slate-100 rounded-2xl px-4 py-4 outline-none font-semibold shadow-sm focus:ring-4 focus:ring-emerald-500/5 transition-all">
                            <option value="">請先填寫 API 網址...</option>
                        </select>
                    </div>
                    <div class="space-y-3">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">費用年月 (多選)</label>
                        <div id="monthGrid" class="grid grid-cols-3 gap-2.5 max-h-52 overflow-y-auto custom-scrollbar pr-1"></div>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">收款日期</label>
                        <input type="date" id="payDate" class="w-full bg-white/50 border border-slate-100 rounded-2xl px-4 py-4 outline-none font-semibold text-slate-600 shadow-sm">
                    </div>
                    <button id="submitBtn" onclick="submitData()" class="btn-gradient w-full text-white font-black py-4 rounded-2xl transition-all text-sm tracking-widest">確認登記</button>
                </div>
            </div>
        </div>

        <!-- 右側：數據儀表板 -->
        <div class="lg:col-span-8 space-y-8">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div class="glass-card p-6 rounded-[2.5rem]">
                    <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">收費總金額</p>
                    <h3 class="text-3xl font-extrabold text-slate-900" id="totalAmount">0</h3>
                </div>
                <div class="glass-card p-6 rounded-[2.5rem]">
                    <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">總筆數</p>
                    <h3 class="text-3xl font-extrabold text-slate-900" id="totalCount">0</h3>
                </div>
                <div class="p-6 rounded-[2.5rem] bg-slate-900 text-white flex flex-col justify-center">
                    <p class="opacity-50 text-[10px] font-black uppercase tracking-widest mb-1">每月金額</p>
                    <h3 class="text-2xl font-extrabold">NT$ 200</h3>
                </div>
            </div>

            <div class="glass-card rounded-[3rem] overflow-hidden">
                <div class="p-8 border-b flex justify-between items-center bg-white/50">
                    <h3 class="text-xl font-black text-slate-800">收款明細紀錄</h3>
                    <button onclick="openPreview()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-xs font-black">年度總表</button>
                </div>
                <div class="px-8 py-4 bg-slate-50/50 flex gap-4">
                    <input type="text" id="searchInput" oninput="renderTable()" placeholder="搜尋姓名..." class="flex-1 bg-white border border-slate-100 rounded-xl px-4 py-2 text-xs outline-none">
                    <select id="filterMonth" onchange="renderTable()" class="bg-white border border-slate-100 rounded-xl px-4 py-2 text-xs outline-none"></select>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="text-slate-400 text-[10px] uppercase font-black">
                                <th class="px-8 py-4">繳款人</th>
                                <th class="px-8 py-4">費用年月</th>
                                <th class="px-8 py-4">收款日期</th>
                                <th class="px-8 py-4 text-right">金額</th>
                                <th class="px-8 py-4 text-center">刪除</th>
                            </tr>
                        </thead>
                        <tbody id="recordTableBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="previewModal" class="flex items-center justify-center p-6">
    <div class="bg-white w-full max-w-5xl max-h-[85vh] rounded-[3rem] shadow-2xl flex flex-col overflow-hidden">
        <div class="p-8 border-b flex justify-between items-center">
            <h3 class="text-2xl font-black" id="previewTitle">年度繳費總表</h3>
            <button onclick="closePreview()" class="text-slate-400 text-2xl">&times;</button>
        </div>
        <div class="flex-1 overflow-auto p-8 bg-slate-50/30">
            <table class="w-full preview-table bg-white rounded-2xl overflow-hidden" id="tableForPDF">
                <thead><tr id="previewHeader"></tr></thead>
                <tbody id="previewBody"></tbody>
            </table>
        </div>
        <div class="p-8 border-t flex gap-4">
            <button onclick="downloadCSV()" class="flex-1 py-4 bg-emerald-50 text-emerald-600 font-bold rounded-2xl">CSV 下載</button>
            <button onclick="downloadPDF()" class="flex-1 py-4 btn-gradient text-white font-bold rounded-2xl">PDF 下載</button>
        </div>
    </div>
</div>

<script>
    // --- 請在這裡填入你的 Google Apps Script 部署網址 ---
    const API_URL = 'https://script.google.com/macros/s/AKfycbxCbfV9gMe3eRDzSNiGo39gpgbUPVKr7Tjj5eJeapmahQj3cqvXm2LRzyidknr7sZJXyg/exec'; 
    
    let MEMBERS = []; 
    const MONTHLY_FEE = 200;
    let records = [];
    let selectedMember = "";
    let selectedMonths = [];
    let currentReportData = { year: "", csv: "", pdfRows: [], pdfHeaders: [] };

    window.onload = () => {
        document.getElementById('payDate').valueAsDate = new Date();
        initMonths();
        if(API_URL.includes('exec')) {
            fetchData();
        } else {
            document.getElementById('memberSelect').innerHTML = '<option value="">請填寫 API 網址</option>';
        }
    };

    function initMonths() {
        const monthGrid = document.getElementById('monthGrid');
        const filterMonthSelect = document.getElementById('filterMonth');
        filterMonthSelect.innerHTML = '<option value="">所有月份</option>';
        const now = new Date();
        for (let i = -5; i < 12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
            const val = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2, '0')}`;
            const label = `${d.getFullYear()}/${d.getMonth()+1}月`;
            
            const opt = document.createElement('option');
            opt.value = val; opt.innerText = label;
            filterMonthSelect.appendChild(opt);

            const item = document.createElement('div');
            item.className = "month-item p-3 rounded-2xl border border-slate-100 bg-white cursor-pointer text-center transition-all hover:border-emerald-200";
            item.innerHTML = `<span class="text-[10px] opacity-40 block">${d.getFullYear()}</span><span class="text-sm font-bold">${d.getMonth()+1}月</span>`;
            item.onclick = () => {
                if(selectedMonths.includes(val)) {
                    selectedMonths = selectedMonths.filter(m => m !== val);
                    item.classList.remove('selected');
                } else {
                    selectedMonths.push(val);
                    item.classList.add('selected');
                }
            };
            monthGrid.appendChild(item);
        }
    }

    async function fetchData() {
        try {
            const resp = await fetch(API_URL);
            const data = await resp.json();
            
            // 更新名單
            if (data.members && data.members.length > 0) {
                MEMBERS = [...new Set(data.members)].filter(n => n).sort();
            } else if (Array.isArray(data)) {
                MEMBERS = [...new Set(data.map(r => r.姓名))].filter(n => n).sort();
            } else if (data.records) {
                MEMBERS = [...new Set(data.records.map(r => r.姓名))].filter(n => n).sort();
            }

            const memberSelect = document.getElementById('memberSelect');
            memberSelect.innerHTML = '<option value="">請選擇繳款人...</option>';
            MEMBERS.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.innerText = name;
                memberSelect.appendChild(opt);
            });

            records = Array.isArray(data) ? data : (data.records || []);
            renderTable();
        } catch (e) { 
            console.error("載入失敗:", e);
            document.getElementById('memberSelect').innerHTML = '<option value="">API 連線失敗</option>';
        }
    }

    async function submitData() {
        if(!selectedMember || selectedMonths.length === 0) return alert("請填寫姓名與月份");
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = "傳送中...";

        const payload = {
            records: selectedMonths.map(m => ({
                name: selectedMember,
                targetMonth: m,
                payDate: document.getElementById('payDate').value,
                amount: MONTHLY_FEE
            }))
        };

        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("✅ 登記完成");
            location.reload();
        } catch (e) {
            alert("提交失敗，請檢查網路");
            btn.disabled = false;
            btn.innerHTML = "確認登記";
        }
    }

    async function deleteRecord(rowId) {
        if(!confirm("確定刪除此筆記錄？")) return;
        try {
            await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ method: 'DELETE', rowId: rowId }) 
            });
            fetchData();
        } catch (e) { alert("刪除失敗"); }
    }

    function renderTable() {
        const nameQuery = document.getElementById('searchInput').value.toLowerCase();
        const monthQuery = document.getElementById('filterMonth').value;
        const tbody = document.getElementById('recordTableBody');
        
        let filtered = records.filter(r => {
            const matchName = r.姓名 && r.姓名.toString().toLowerCase().includes(nameQuery);
            const matchMonth = monthQuery === "" || r.費用年月 === monthQuery;
            return matchName && matchMonth;
        });

        filtered.sort((a, b) => b.費用年月.localeCompare(a.費用年月));

        tbody.innerHTML = filtered.map(r => {
            let formattedPayDate = "-";
            if(r.收款日期) {
                const d = new Date(r.收款日期);
                formattedPayDate = !isNaN(d) ? `${d.getFullYear()}/${(d.getMonth()+1)}/${d.getDate()}` : r.收款日期;
            }

            return `
            <tr class="hover:bg-slate-50 transition-all">
                <td class="px-8 py-5 font-bold text-sm">${r.姓名}</td>
                <td class="px-8 py-5"><span class="px-2 py-1 rounded bg-emerald-50 text-emerald-600 text-[10px] font-bold">${r.費用年月}</span></td>
                <td class="px-8 py-5 text-slate-500 text-xs">${formattedPayDate}</td>
                <td class="px-8 py-5 text-right font-black text-sm">NT$ ${r.金額}</td>
                <td class="px-8 py-5 text-center">
                    <button onclick="deleteRecord(${r.rowId})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>
            `;
        }).join('');

        document.getElementById('totalAmount').innerText = filtered.reduce((acc, curr) => acc + Number(curr.金額), 0).toLocaleString();
        document.getElementById('totalCount').innerText = filtered.length;
    }

    function openPreview() {
        let targetYear = new Date().getFullYear();
        currentReportData.year = targetYear;
        const months = Array.from({ length: 12 }, (_, i) => (i + 1).toString().padStart(2, '0'));
        currentReportData.pdfHeaders = ["姓名", ...months.map(m => `${parseInt(m)}月`)];
        document.getElementById('previewHeader').innerHTML = currentReportData.pdfHeaders.map(h => `<th>${h}</th>`).join('');

        let csvRows = [currentReportData.pdfHeaders.join(",")];
        let bodyHtml = "";
        currentReportData.pdfRows = [];

        MEMBERS.forEach(name => {
            const userRecords = records.filter(r => r.姓名 === name && r.費用年月.toString().startsWith(targetYear));
            let rowData = [name];
            let rowHtml = `<td class="font-bold bg-slate-50">${name}</td>`;
            months.forEach(m => {
                const paid = userRecords.some(r => r.費用年月 === `${targetYear}-${m}`);
                rowData.push(paid ? "V" : "-");
                rowHtml += paid ? `<td class="status-v">V</td>` : `<td>-</td>`;
            });
            csvRows.push(rowData.join(","));
            currentReportData.pdfRows.push(rowData);
            bodyHtml += `<tr>${rowHtml}</tr>`;
        });

        currentReportData.csv = "\ufeff" + csvRows.join("\n");
        document.getElementById('previewBody').innerHTML = bodyHtml;
        document.getElementById('previewModal').style.display = 'flex';
    }

    function closePreview() { document.getElementById('previewModal').style.display = 'none'; }
    function downloadCSV() {
        const blob = new Blob([currentReportData.csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${currentReportData.year}_Fee_Report.csv`;
        a.click();
    }
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        doc.text(`${currentReportData.year} Fee Report`, 14, 20);
        doc.autoTable({ startY: 30, head: [currentReportData.pdfHeaders], body: currentReportData.pdfRows });
        doc.save(`${currentReportData.year}_Report.pdf`);
    }
</script>

</body>
</html>
