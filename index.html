<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTech æƒåœ°è²»ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #10b981;
            --secondary: #3b82f6;
        }
        body {
            background: linear-gradient(135deg, #f0fdf4 0%, #eff6ff 100%);
            min-height: 100vh;
            font-family: "Microsoft JhengHei", sans-serif;
        }
        .eco-gradient {
            background: linear-gradient(90deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        .dynamic-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.4;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <canvas id="bgCanvas" class="dynamic-bg"></canvas>

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold eco-gradient">EcoTech æƒåœ°è²»ç®¡ç†</h1>
            <button onclick="toggleQueryModal()" class="bg-white border-2 border-emerald-500 text-emerald-600 px-6 py-2 rounded-full hover:bg-emerald-500 hover:text-white transition-all font-medium flex items-center gap-2">
                ğŸ” æŸ¥è©¢èˆ‡å ±è¡¨
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- æ”¶è²»ç™»è¨˜é é¢ -->
            <section class="glass-card p-6 rounded-3xl">
                <h2 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2">
                    <span class="p-2 bg-emerald-100 rounded-lg text-emerald-600">ğŸ“</span> æ–°å¢æ”¶è²»ç™»è¨˜
                </h2>
                
                <form id="payForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">ç¹³æ¬¾äººå§“å</label>
                        <select id="userName" class="w-full border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none shadow-sm" required>
                            <option value="">è«‹é¸æ“‡å§“å...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-2">æ”¶è²»å¹´æœˆ (å¯è¤‡é¸)</label>
                        <div id="monthGrid" class="grid grid-cols-3 gap-2">
                            <!-- JS ç”Ÿæˆæœˆä»½æŒ‰éˆ• -->
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">é‡‘é¡ (å›ºå®š)</label>
                        <div class="flex items-center gap-2 text-2xl font-bold text-emerald-600">
                            NT$ <span id="displayAmount">0</span>
                        </div>
                        <p class="text-xs text-gray-400">â€» æ¯æœˆå›ºå®š 200 å…ƒ</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-500 mb-1">æ”¶è²»æ—¥æœŸ</label>
                        <input type="date" id="payDate" class="w-full border-gray-200 rounded-xl p-3 outline-none" required>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold text-lg hover:bg-emerald-600 shadow-lg shadow-emerald-200 transition-all transform active:scale-95">
                        ç¢ºèªç™»è¨˜
                    </button>
                </form>
            </section>

            <!-- æœ€è¿‘æ”¶è²»ç´€éŒ„ (24H) -->
            <section class="glass-card p-6 rounded-3xl">
                <h2 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-2">
                    <span class="p-2 bg-blue-100 rounded-lg text-blue-600">ğŸ•’</span> 24å°æ™‚å…§ç´€éŒ„
                </h2>
                <div id="recentRecords" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    <!-- JS ç”Ÿæˆç´€éŒ„å¡ç‰‡ -->
                    <div class="text-center text-gray-400 py-10 italic">è¼‰å…¥è³‡æ–™ä¸­...</div>
                </div>
            </section>
        </div>
    </div>

    <!-- æŸ¥è©¢ Modal -->
    <div id="queryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-emerald-50">
                <h3 class="text-xl font-bold text-emerald-800">æŸ¥è©¢ç´€éŒ„èˆ‡å ±è¡¨å°å‡º</h3>
                <button onclick="toggleQueryModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4 bg-white">
                <select id="queryName" class="border rounded-xl p-2 outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="">æ‰€æœ‰å§“å</option>
                </select>
                <input type="month" id="queryMonth" class="border rounded-xl p-2 outline-none">
                <div class="flex gap-2">
                    <button onclick="exportExcel()" class="flex-1 bg-green-100 text-green-700 px-3 py-2 rounded-xl text-sm font-bold hover:bg-green-200 transition-all">Excel</button>
                    <button onclick="exportPDF()" class="flex-1 bg-red-100 text-red-700 px-3 py-2 rounded-xl text-sm font-bold hover:bg-red-200 transition-all">PDF</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 pt-0">
                <table class="w-full text-left">
                    <thead class="sticky top-0 bg-white">
                        <tr class="text-gray-400 text-sm border-b uppercase">
                            <th class="py-3 font-medium">å§“å</th>
                            <th class="py-3 font-medium">å¹´æœˆ</th>
                            <th class="py-3 font-medium">é‡‘é¡</th>
                            <th class="py-3 font-medium">æ”¶è²»æ—¥</th>
                        </tr>
                    </thead>
                    <tbody id="queryResultBody" class="text-gray-600">
                        <!-- JS å‹•æ…‹æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šèˆ‡åˆå§‹åŒ– ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5FWQw4ai_eYiAtLxOYbiGKxPvS8C3w8pb7PCBO0feqWidLgqLSN0AA-bpOwLQWPMFbQ/exec"; // è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ GAS éƒ¨ç½²ç¶²å€
        let allRecords = [];
        let userNames = [];
        let selectedMonths = [];

        // --- èƒŒæ™¯å‹•ç•« ---
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function initBg() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            particles = [];
            for(let i=0; i<30; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    r: Math.random() * 5 + 2,
                    dx: (Math.random() - 0.5) * 0.5,
                    dy: (Math.random() - 0.5) * 0.5,
                    opacity: Math.random() * 0.5
                });
            }
        }
        function animate() {
            ctx.clearRect(0,0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                ctx.fillStyle = `rgba(16, 185, 129, ${p.opacity})`;
                ctx.fill();
                p.x += p.dx; p.y += p.dy;
                if(p.x < 0 || p.x > canvas.width) p.dx *= -1;
                if(p.y < 0 || p.y > canvas.height) p.dy *= -1;
            });
            requestAnimationFrame(animate);
        }
        window.addEventListener('resize', initBg);
        initBg(); animate();

        // --- æœˆä»½é¸å–å™¨ç”Ÿæˆ ---
        function generateMonthGrid() {
            const grid = document.getElementById('monthGrid');
            const now = new Date();
            for(let i=0; i<12; i++) {
                const date = new Date(now.getFullYear(), i, 1);
                const val = `${now.getFullYear()}-${(i+1).toString().padStart(2,'0')}`;
                const btn = document.createElement('div');
                btn.textContent = `${i+1}æœˆ`;
                btn.className = "cursor-pointer border border-gray-100 rounded-lg py-2 text-center text-sm hover:border-emerald-300 transition-all";
                btn.dataset.val = val;
                btn.onclick = () => {
                    if(selectedMonths.includes(val)) {
                        selectedMonths = selectedMonths.filter(m => m !== val);
                        btn.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-500');
                    } else {
                        selectedMonths.push(val);
                        btn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                    }
                    document.getElementById('displayAmount').textContent = selectedMonths.length * 200;
                };
                grid.appendChild(btn);
            }
        }

        // --- API é€šè¨Š ---
        async function callAPI(data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (e) {
                console.error("API Error", e);
                return null;
            }
        }

        async function initData() {
            if(!SCRIPT_URL) {
                console.warn("æœªå¡«å¯« SCRIPT_URL");
                return;
            }
            const res = await callAPI({ action: 'getInitialData' });
            if(res) {
                userNames = res.names;
                allRecords = res.records;
                renderUI();
            }
        }

        function renderUI() {
            // å¡«å……ä¸‹æ‹‰é¸å–®
            const userSelect = document.getElementById('userName');
            const querySelect = document.getElementById('queryName');
            userSelect.innerHTML = '<option value="">è«‹é¸æ“‡å§“å...</option>';
            querySelect.innerHTML = '<option value="">æ‰€æœ‰å§“å</option>';
            userNames.forEach(name => {
                const opt = `<option value="${name}">${name}</option>`;
                userSelect.innerHTML += opt;
                querySelect.innerHTML += opt;
            });

            // æ¸²æŸ“æœ€è¿‘ç´€éŒ„ (24H)
            const list = document.getElementById('recentRecords');
            const now = new Date();
            const recent = allRecords.filter(r => (now - new Date(r.timestamp)) < 24 * 60 * 60 * 1000)
                                    .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = recent.length ? '' : '<div class="text-center text-gray-400 py-10 italic">24å°æ™‚å…§ç„¡æ–°ç´€éŒ„</div>';
            recent.forEach(r => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50 animate-fade-in";
                card.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-700">${r.name}</div>
                        <div class="text-xs text-gray-400">å¹´æœˆ: ${r.months}</div>
                        <div class="text-xs text-emerald-500 font-medium">NT$ ${r.amount}</div>
                    </div>
                    <button onclick="handleDelete('${r.id}')" class="text-red-300 hover:text-red-500 p-2 transition-colors">ğŸ—‘ï¸</button>
                `;
                list.appendChild(card);
            });

            updateQueryResult();
        }

        // --- è¡¨å–®æäº¤ ---
        document.getElementById('payForm').onsubmit = async (e) => {
            e.preventDefault();
            if(!selectedMonths.length) return alert('è«‹é¸æ“‡æœˆä»½');
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = "è™•ç†ä¸­...";

            const data = {
                name: document.getElementById('userName').value,
                months: selectedMonths,
                amount: selectedMonths.length * 200,
                date: document.getElementById('payDate').value
            };

            const res = await callAPI({ action: 'addRecord', data });
            if(res && res.success) {
                alert('ç™»è¨˜æˆåŠŸï¼');
                location.reload();
            } else {
                alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL æˆ–ç¶²è·¯è¨­å®šã€‚');
                btn.disabled = false;
                btn.textContent = "ç¢ºèªç™»è¨˜";
            }
        };

        // --- åˆªé™¤åŠŸèƒ½ ---
        async function handleDelete(id) {
            if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†æœ€è¿‘ç´€éŒ„å—ï¼Ÿ')) return;
            const res = await callAPI({ action: 'deleteRecord', id });
            if(res && res.success) {
                allRecords = allRecords.filter(r => r.id !== id);
                renderUI();
            }
        }

        // --- æŸ¥è©¢èˆ‡ç¯©é¸ ---
        function updateQueryResult() {
            const nameFilt = document.getElementById('queryName').value;
            const monthFilt = document.getElementById('queryMonth').value;
            
            const filtered = allRecords.filter(r => {
                const matchName = !nameFilt || r.name === nameFilt;
                const matchMonth = !monthFilt || r.months.includes(monthFilt);
                return matchName && matchMonth;
            });

            const body = document.getElementById('queryResultBody');
            body.innerHTML = '';
            filtered.forEach(r => {
                body.innerHTML += `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <td class="py-4 font-medium text-gray-700">${r.name}</td>
                        <td class="py-4 text-sm">${r.months}</td>
                        <td class="py-4 text-sm text-emerald-600 font-bold">$${r.amount}</td>
                        <td class="py-4 text-sm text-gray-400">${r.date}</td>
                    </tr>
                `;
            });
            window.lastFiltered = filtered;
        }

        document.getElementById('queryName').onchange = updateQueryResult;
        document.getElementById('queryMonth').oninput = updateQueryResult;

        // --- å ±è¡¨å°å‡º ---
        function exportExcel() {
            const data = window.lastFiltered.map(r => ({
                'ç¹³æ¬¾äºº': r.name,
                'æ”¶è²»å¹´æœˆ': r.months,
                'ç¸½é‡‘é¡': r.amount,
                'æ”¶è²»æ—¥æœŸ': r.date
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æ”¶è²»ç´€éŒ„");
            XLSX.writeFile(wb, `æƒåœ°è²»å ±è¡¨_${new Date().toLocaleDateString()}.xlsx`);
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("æƒåœ°è²»ç®¡ç†å ±è¡¨", 14, 15);
            const tableData = window.lastFiltered.map(r => [r.name, r.months, r.amount, r.date]);
            doc.autoTable({
                head: [['å§“å', 'å¹´æœˆ', 'é‡‘é¡', 'æ—¥æœŸ']],
                body: tableData,
                startY: 20,
            });
            doc.save(`æƒåœ°è²»å ±è¡¨_${new Date().toLocaleDateString()}.pdf`);
        }

        // --- UI æ§åˆ¶ ---
        function toggleQueryModal() {
            document.getElementById('queryModal').classList.toggle('hidden');
        }

        window.onload = () => {
            generateMonthGrid();
            document.getElementById('payDate').valueAsDate = new Date();
            initData();
        };
    </script>
</body>
</html>
