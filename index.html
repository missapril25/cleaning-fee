<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>掃地費登記表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 SheetJS 用於匯出 Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        * { box-sizing: border-box; }
        
        body { background-color: #f3ede4; font-family: 'Noto Sans TC', sans-serif; color: #444; }
        .ethno-card { background: #ffffff; border-radius: 1.5rem; border: 2px solid #a67c52; }
        .ethno-pattern { height: 12px; background: repeating-linear-gradient(45deg, #c05c3c, #c05c3c 10px, #e9c46a 10px, #e9c46a 20px, #2a9d8f 20px, #2a9d8f 30px); }
        .btn-ethno { background-color: #c05c3c; color: white; transition: all 0.3s; cursor: pointer; }
        .btn-ethno:hover { background-color: #a04a2f; transform: translateY(-1px); }
        
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #c05c3c; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="py-12 px-4">
    <div class="max-w-4xl mx-auto space-y-8">
        <!-- 登記表單 -->
        <div class="ethno-card shadow-2xl overflow-hidden">
            <div class="ethno-pattern"></div>
            <div class="p-8">
                <header class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-amber-900 tracking-wider">掃地費登記表</h1>
                </header>
                <form id="paymentForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-stone-700 mb-2">姓名</label>
                        <input type="text" id="name" required placeholder="輸入姓名" class="w-full px-4 py-3 rounded-xl border-2 border-stone-100 outline-none focus:border-amber-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-stone-700 mb-2">收費年份</label>
                        <select id="year" class="w-full px-4 py-3 rounded-xl border-2 border-stone-100 outline-none focus:border-amber-500 bg-white cursor-pointer"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-stone-700 mb-2">收費月份</label>
                        <select id="month" class="w-full px-4 py-3 rounded-xl border-2 border-stone-100 outline-none focus:border-amber-500 bg-white cursor-pointer">
                            <option value="1">1 月</option><option value="2">2 月</option><option value="3">3 月</option><option value="4">4 月</option><option value="5">5 月</option><option value="6">6 月</option><option value="7">7 月</option><option value="8">8 月</option><option value="9">9 月</option><option value="10">10 月</option><option value="11">11 月</option><option value="12">12 月</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-stone-700 mb-2">金額 (TWD)</label>
                        <input type="number" id="amount" required placeholder="例如：200" class="w-full px-4 py-3 rounded-xl border-2 border-stone-100 outline-none focus:border-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-stone-700 mb-2">實際收費日期</label>
                        <input type="date" id="paymentDate" required class="w-full px-4 py-3 rounded-xl border-2 border-stone-100 outline-none focus:border-amber-500">
                    </div>
                    <button type="submit" id="submitBtn" class="md:col-span-2 btn-ethno font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 text-lg">
                        <span id="btnText">確認登記並上傳</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- 清單區域 -->
        <div class="ethno-card shadow-xl bg-white overflow-hidden">
            <div class="ethno-pattern"></div>
            <div class="p-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="text-2xl font-bold text-amber-900">收費登記清單</h2>
                    <div class="flex gap-3">
                        <button onclick="fetchData()" class="bg-stone-100 hover:bg-stone-200 text-stone-600 py-2.5 px-5 rounded-xl text-sm font-bold transition-colors">重新整理</button>
                        <button id="excelDownloadBtn" onclick="downloadExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 px-5 rounded-xl shadow-md text-sm font-bold transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span>匯出 Excel 報表</span>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="mainTable" class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-stone-50 border-b-2 border-stone-100">
                                <th class="py-4 px-4 w-16 text-center text-xs font-bold text-stone-500">序號</th>
                                <th class="py-4 px-4 text-xs font-bold text-stone-500">姓名</th>
                                <th class="py-4 px-4 text-xs font-bold text-stone-500">繳費年月</th>
                                <th class="py-4 px-4 text-xs font-bold text-stone-500 text-right">金額</th>
                                <th class="py-4 px-4 text-xs font-bold text-stone-500">收費日期</th>
                                <th class="py-4 px-4 text-center text-xs font-bold text-stone-500">刪除</th>
                            </tr>
                        </thead>
                        <tbody id="listBody" class="divide-y divide-stone-50">
                            <tr><td colspan="6" class="py-12 text-center text-stone-400 italic">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 查詢區域 -->
        <div class="ethno-card shadow-xl overflow-hidden bg-stone-50/50">
            <div class="p-8">
                <h2 class="text-xl font-bold text-amber-900 mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    查詢個人繳費紀錄
                </h2>
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="searchName" placeholder="輸入姓名查詢" class="flex-1 px-4 py-3 rounded-xl border-2 border-stone-200 outline-none focus:border-amber-500 transition-colors">
                    <button onclick="searchRecords()" class="bg-amber-700 hover:bg-amber-800 text-white font-bold py-3 px-8 rounded-xl transition-all shadow-md">查詢</button>
                </div>
                <div id="searchResultArea" class="hidden">
                    <div class="bg-white rounded-xl border border-stone-200 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-stone-100">
                                <tr>
                                    <th class="py-3 px-4 text-left font-bold text-stone-600">年月</th>
                                    <th class="py-3 px-4 text-left font-bold text-stone-600">收費日期</th>
                                    <th class="py-3 px-4 text-right font-bold text-stone-600">金額</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultBody" class="divide-y divide-stone-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 刪除確認 Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-stone-900/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl border-2 border-amber-900/10 text-center">
            <h3 class="text-xl font-bold text-stone-800 mb-4">確認要刪除嗎？</h3>
            <div class="flex gap-4">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 bg-stone-100 hover:bg-stone-200 rounded-xl font-bold transition-colors">取消</button>
                <button id="confirmDeleteBtn" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold transition-colors">確定</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyEHJqZuJ9yOEaLIL9qTwDzZKplCoz6uVf-nN0fjoytPorA4NYAWjwCfsE2365Lx1AJkQ/exec"; 
        const form = document.getElementById('paymentForm');
        const listBody = document.getElementById('listBody');
        const submitBtn = document.getElementById('submitBtn');
        let cachedData = []; 
        let currentDeleteId = null;

        function init() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('year');
            yearSelect.innerHTML = ''; 
            for (let i = currentYear - 1; i <= currentYear + 1; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = i + ' 年';
                if (i === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            document.getElementById('paymentDate').valueAsDate = new Date();
            document.getElementById('month').value = new Date().getMonth() + 1;
            fetchData();
        }

        async function fetchData() {
            listBody.innerHTML = `<tr><td colspan="6" class="py-12 text-center text-stone-400 italic">正在載入...</td></tr>`;
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                if (Array.isArray(data)) {
                    // 修正：確保姓名轉為字串再排序，避免資料庫回傳純數字導致報錯
                    data.sort((a, b) => String(a['姓名'] || '').localeCompare(String(b['姓名'] || ''), 'zh-Hant'));
                }
                cachedData = data; 
                renderTable(data);
            } catch (error) {
                listBody.innerHTML = `<tr><td colspan="6" class="py-12 text-center text-red-500">載入失敗</td></tr>`;
            }
        }

        function renderTable(data) {
            listBody.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                listBody.innerHTML = `<tr><td colspan="6" class="py-12 text-center text-stone-400">尚無資料</td></tr>`;
                return;
            }
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-amber-50/30 transition-colors";
                const d = new Date(item['實際收費日期']);
                const formattedDate = isNaN(d.getTime()) ? '-' : `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
                
                row.innerHTML = `
                    <td class="py-4 px-4 text-center text-stone-400 text-xs">${index + 1}</td>
                    <td class="py-4 px-4 font-bold text-stone-700">${item['姓名'] || '未填寫'}</td>
                    <td class="py-4 px-4 text-sm text-stone-500">${item['年份'] || '-'} / ${item['月份'] || '-'}月</td>
                    <td class="py-4 px-4 font-bold text-amber-700 text-right">$ ${parseInt(item['金額'] || 0).toLocaleString()}</td>
                    <td class="py-4 px-4 text-xs text-stone-500 font-mono">${formattedDate}</td>
                    <td class="py-4 px-4 text-center">
                        <button onclick="requestDelete('${item['ID']}')" class="text-stone-300 hover:text-red-500 p-2 transition-colors flex items-center justify-center mx-auto" title="刪除紀錄">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                `;
                listBody.appendChild(row);
            });
        }

        function downloadExcel() {
            if (cachedData.length === 0) {
                alert("目前沒有資料可以匯出。");
                return;
            }

            const exportData = cachedData.map((item, index) => {
                const d = new Date(item['實際收費日期']);
                const formattedDate = isNaN(d.getTime()) ? '-' : `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
                
                return {
                    "序號": index + 1,
                    "姓名": item['姓名'] || '未填寫',
                    "繳費年份": item['年份'] || '-',
                    "繳費月份": item['月份'] || '-',
                    "金額 (TWD)": parseInt(item['金額'] || 0),
                    "實際收費日期": formattedDate
                };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            ws['!cols'] = [{ wch: 6 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 15 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "收費清單");
            const fileName = `掃地費登記清單_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function searchRecords() {
            const name = document.getElementById('searchName').value.trim();
            const resultArea = document.getElementById('searchResultArea');
            const resultBody = document.getElementById('searchResultBody');
            
            if (!name) return;
            
            // 修正：在 filter 中強制將 item['姓名'] 轉為字串，防止數字型態導致 includes 報錯
            const results = cachedData.filter(item => String(item['姓名'] || '').includes(name));
            resultBody.innerHTML = '';
            
            if (results.length > 0) {
                results.forEach(item => {
                    const d = new Date(item['實際收費日期']);
                    const formattedDate = isNaN(d.getTime()) ? '-' : `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
                    const row = `<tr>
                        <td class="py-3 px-4">${item['年份']}/${item['月份']}</td>
                        <td class="py-3 px-4">${formattedDate}</td>
                        <td class="py-3 px-4 text-right font-bold text-amber-700">$${parseInt(item['金額']).toLocaleString()}</td>
                    </tr>`;
                    resultBody.innerHTML += row;
                });
                resultArea.classList.remove('hidden');
            } else {
                alert("找不到 " + name + " 的紀錄");
                resultArea.classList.add('hidden');
            }
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const originalBtnText = document.getElementById('btnText').textContent;
            document.getElementById('btnText').textContent = "登記中...";
            submitBtn.disabled = true;
            const payload = {
                action: 'add',
                name: document.getElementById('name').value,
                year: document.getElementById('year').value,
                month: document.getElementById('month').value,
                amount: document.getElementById('amount').value,
                payDate: document.getElementById('paymentDate').value
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                form.reset();
                init();
            } catch(e) {}
            document.getElementById('btnText').textContent = originalBtnText;
            submitBtn.disabled = false;
        };

        window.requestDelete = (id) => {
            currentDeleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            document.getElementById('deleteModal').classList.add('hidden');
        };

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', id: currentDeleteId }) });
            closeDeleteModal();
            fetchData();
        };

        window.onload = init;
    </script>
</body>
</html>
